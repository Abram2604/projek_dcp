DROP PROCEDURE IF EXISTS sp_dashboard_bph;

DELIMITER $$

CREATE PROCEDURE sp_dashboard_bph()
BEGIN
    -- 1. Hitung Total Anggota Aktif
    SELECT COUNT(*) INTO @total_anggota FROM Anggota WHERE status_aktif = 1;

    -- 2. Hitung Hadir Hari Ini
    SELECT COUNT(*) INTO @hadir_hari_ini FROM Riwayat_Absensi 
    WHERE tanggal = CURDATE() AND status_kehadiran = 'HADIR';

    -- 3. Hitung Dinas Hari Ini (BARU DITAMBAHKAN)
    -- Menggunakan LIKE 'DINAS%' agar menangkap 'DINAS', 'DINAS_LUAR', dll
    SELECT COUNT(*) INTO @dinas_hari_ini FROM Riwayat_Absensi 
    WHERE tanggal = CURDATE() AND status_kehadiran LIKE 'DINAS%';

    -- 4. Hitung Laporan Masuk Hari Ini
    SELECT COUNT(*) INTO @laporan_masuk FROM Laporan_Harian 
    WHERE tanggal_laporan = CURDATE();

    -- 5. Hitung Saldo Kas Bulan Ini
    SELECT COALESCE(SUM(sisa_saldo), 0) INTO @saldo_kas FROM Periode_Keuangan 
    WHERE bulan = MONTH(CURDATE()) AND tahun = YEAR(CURDATE());

    -- Outputkan hasilnya (Tambahkan dinas_hari_ini)
    SELECT 
        @total_anggota AS total_anggota,
        @hadir_hari_ini AS hadir_hari_ini,
        @dinas_hari_ini AS dinas_hari_ini,
        @laporan_masuk AS laporan_masuk,
        @saldo_kas AS saldo_kas;
END$$

DELIMITER ;

DELIMITER $$

CREATE PROCEDURE sp_dashboard_anggota(IN p_id_anggota INT)
BEGIN
    -- 1. Cek Jam Masuk Hari Ini
    SELECT jam_masuk INTO @jam_masuk 
    FROM Riwayat_Absensi 
    WHERE id_anggota = p_id_anggota 
    AND tanggal = CURDATE() 
    LIMIT 1;

    -- 2. Cek Apakah Sudah Lapor Hari Ini (1 = Sudah, 0 = Belum)
    SELECT COUNT(*) INTO @sudah_lapor 
    FROM Laporan_Harian 
    WHERE id_anggota = p_id_anggota 
    AND tanggal_laporan = CURDATE();

    -- Outputkan hasilnya
    SELECT 
        COALESCE(@jam_masuk, NULL) AS jam_masuk,
        @sudah_lapor AS status_lapor;
END$$

DELIMITER ;

DROP PROCEDURE IF EXISTS sp_divisi_list;
DROP PROCEDURE IF EXISTS sp_program_kerja_by_divisi;
DROP PROCEDURE IF EXISTS sp_laporan_saldo_bph;
DROP PROCEDURE IF EXISTS sp_laporan_saldo_divisi;
DROP PROCEDURE IF EXISTS sp_laporan_list;
DROP PROCEDURE IF EXISTS sp_laporan_detail;
DROP PROCEDURE IF EXISTS sp_laporan_pengeluaran_detail;
DROP PROCEDURE IF EXISTS sp_periode_keuangan_get;
DROP PROCEDURE IF EXISTS sp_laporan_create;
DROP PROCEDURE IF EXISTS sp_pengeluaran_create;
DROP PROCEDURE IF EXISTS sp_keuangan_summary;
DROP PROCEDURE IF EXISTS sp_keuangan_divisi_summary;
DROP PROCEDURE IF EXISTS sp_keuangan_pengeluaran_recent;
DROP PROCEDURE IF EXISTS sp_keuangan_pengeluaran_detail;
DROP PROCEDURE IF EXISTS sp_keuangan_set_saldo_awal;

DELIMITER $$

CREATE PROCEDURE sp_divisi_list()
BEGIN
    SELECT id, nama_divisi, kode_divisi
    FROM Divisi
    ORDER BY nama_divisi;
END$$

CREATE PROCEDURE sp_program_kerja_by_divisi(IN p_id_divisi INT)
BEGIN
    SELECT id, nama_program
    FROM Program_Kerja
    WHERE p_id_divisi IS NULL OR id_divisi = p_id_divisi
    ORDER BY nama_program;
END$$

CREATE PROCEDURE sp_laporan_saldo_bph(IN p_bulan TINYINT, IN p_tahun SMALLINT)
BEGIN
    SELECT
        d.id,
        d.nama_divisi,
        d.kode_divisi,
        COALESCE(pk.saldo_awal, 0) AS saldo_awal,
        COALESCE(pk.total_pengeluaran, 0) AS total_pengeluaran,
        COALESCE(pk.sisa_saldo, 0) AS sisa_saldo
    FROM Divisi d
    LEFT JOIN Periode_Keuangan pk
        ON pk.id_divisi = d.id
        AND pk.bulan = p_bulan
        AND pk.tahun = p_tahun
    ORDER BY d.nama_divisi;
END$$

CREATE PROCEDURE sp_laporan_saldo_divisi(IN p_id_divisi INT, IN p_bulan TINYINT, IN p_tahun SMALLINT)
BEGIN
    SELECT
        d.id,
        d.nama_divisi,
        d.kode_divisi,
        COALESCE(pk.saldo_awal, 0) AS saldo_awal,
        COALESCE(pk.total_pengeluaran, 0) AS total_pengeluaran,
        COALESCE(pk.sisa_saldo, 0) AS sisa_saldo
    FROM Divisi d
    LEFT JOIN Periode_Keuangan pk
        ON pk.id_divisi = d.id
        AND pk.bulan = p_bulan
        AND pk.tahun = p_tahun
    WHERE d.id = p_id_divisi
    LIMIT 1;
END$$

CREATE PROCEDURE sp_laporan_list(
    IN p_level_akses VARCHAR(10),
    IN p_id_divisi INT,
    IN p_search VARCHAR(200),
    IN p_start_date DATE,
    IN p_end_date DATE,
    IN p_filter_divisi INT
)
BEGIN
    SELECT
        l.id,
        l.tanggal_laporan,
        l.judul_kegiatan,
        l.isi_laporan,
        l.status_laporan,
        l.url_lampiran,
        l.id_divisi,
        d.nama_divisi,
        d.kode_divisi,
        l.id_anggota,
        a.nama_lengkap,
        l.id_program_kerja,
        pk.nama_program,
        COALESCE(SUM(tp.total_nominal), 0) AS total_pengeluaran
    FROM Laporan_Harian l
    JOIN Divisi d ON l.id_divisi = d.id
    JOIN Anggota a ON l.id_anggota = a.id
    LEFT JOIN Program_Kerja pk ON l.id_program_kerja = pk.id
    LEFT JOIN Transaksi_Pengeluaran tp
        ON tp.tanggal_transaksi = l.tanggal_laporan
        AND tp.nama_kegiatan = l.judul_kegiatan
        AND (tp.id_program_kerja <=> l.id_program_kerja)
    WHERE (p_level_akses = 'BPH' OR l.id_divisi = p_id_divisi)
        AND (p_filter_divisi IS NULL OR p_filter_divisi = 0 OR l.id_divisi = p_filter_divisi)
        AND (p_start_date IS NULL OR l.tanggal_laporan >= p_start_date)
        AND (p_end_date IS NULL OR l.tanggal_laporan <= p_end_date)
        AND (
            p_search IS NULL OR p_search = '' OR
            l.judul_kegiatan LIKE CONCAT('%', p_search, '%') OR
            l.isi_laporan LIKE CONCAT('%', p_search, '%') OR
            a.nama_lengkap LIKE CONCAT('%', p_search, '%')
        )
    GROUP BY
        l.id,
        l.tanggal_laporan,
        l.judul_kegiatan,
        l.isi_laporan,
        l.status_laporan,
        l.url_lampiran,
        l.id_divisi,
        d.nama_divisi,
        d.kode_divisi,
        l.id_anggota,
        a.nama_lengkap,
        l.id_program_kerja,
        pk.nama_program
    ORDER BY l.tanggal_laporan DESC, l.id DESC;
END$$

CREATE PROCEDURE sp_laporan_detail(IN p_id_laporan INT)
BEGIN
    SELECT
        l.id,
        l.tanggal_laporan,
        l.judul_kegiatan,
        l.isi_laporan,
        l.status_laporan,
        l.url_lampiran,
        l.id_divisi,
        d.nama_divisi,
        d.kode_divisi,
        l.id_anggota,
        a.nama_lengkap,
        l.id_program_kerja,
        pk.nama_program,
        l.dibuat_pada
    FROM Laporan_Harian l
    JOIN Divisi d ON l.id_divisi = d.id
    JOIN Anggota a ON l.id_anggota = a.id
    LEFT JOIN Program_Kerja pk ON l.id_program_kerja = pk.id
    WHERE l.id = p_id_laporan
    LIMIT 1;
END$$

CREATE PROCEDURE sp_laporan_pengeluaran_detail(IN p_id_laporan INT)
BEGIN
    SELECT
        tp.id,
        tp.tanggal_transaksi,
        tp.nama_kegiatan,
        tp.uraian_pengeluaran,
        tp.volume,
        tp.satuan,
        tp.jumlah_rupiah,
        tp.total_nominal,
        tp.keterangan,
        tp.url_bukti_struk
    FROM Laporan_Harian l
    LEFT JOIN Transaksi_Pengeluaran tp
        ON tp.tanggal_transaksi = l.tanggal_laporan
        AND tp.nama_kegiatan = l.judul_kegiatan
        AND (tp.id_program_kerja <=> l.id_program_kerja)
    WHERE l.id = p_id_laporan
    ORDER BY tp.id ASC;
END$$

CREATE PROCEDURE sp_periode_keuangan_get(IN p_id_divisi INT, IN p_tanggal DATE)
BEGIN
    SELECT id, saldo_awal, total_pengeluaran, sisa_saldo
    FROM Periode_Keuangan
    WHERE id_divisi = p_id_divisi
        AND bulan = MONTH(p_tanggal)
        AND tahun = YEAR(p_tanggal)
    LIMIT 1;
END$$

CREATE PROCEDURE sp_laporan_create(
    IN p_id_divisi INT,
    IN p_id_anggota INT,
    IN p_id_program_kerja INT,
    IN p_tanggal DATE,
    IN p_judul VARCHAR(200),
    IN p_isi TEXT,
    IN p_url_lampiran VARCHAR(255),
    IN p_status VARCHAR(10)
)
BEGIN
    INSERT INTO Laporan_Harian
        (id_divisi, id_anggota, id_program_kerja, tanggal_laporan, judul_kegiatan, isi_laporan, url_lampiran, status_laporan)
    VALUES
        (p_id_divisi, p_id_anggota, p_id_program_kerja, p_tanggal, p_judul, p_isi, p_url_lampiran, p_status);

    SELECT LAST_INSERT_ID() AS id_laporan;
END$$

CREATE PROCEDURE sp_pengeluaran_create(
    IN p_id_periode_keuangan INT,
    IN p_id_program_kerja INT,
    IN p_tanggal DATE,
    IN p_nama_kegiatan VARCHAR(200),
    IN p_uraian TEXT,
    IN p_volume DECIMAL(10,2),
    IN p_satuan VARCHAR(50),
    IN p_jumlah_rupiah DECIMAL(15,2),
    IN p_keterangan VARCHAR(255),
    IN p_url_bukti VARCHAR(255)
)
BEGIN
    DECLARE v_total DECIMAL(15,2);
    SET v_total = COALESCE(p_volume, 1) * COALESCE(p_jumlah_rupiah, 0);

    INSERT INTO Transaksi_Pengeluaran
        (id_periode_keuangan, id_program_kerja, tanggal_transaksi, nama_kegiatan, uraian_pengeluaran, volume, satuan, jumlah_rupiah, keterangan, url_bukti_struk)
    VALUES
        (p_id_periode_keuangan, p_id_program_kerja, p_tanggal, p_nama_kegiatan, p_uraian, p_volume, p_satuan, p_jumlah_rupiah, p_keterangan, p_url_bukti);

    UPDATE Periode_Keuangan
    SET total_pengeluaran = total_pengeluaran + v_total,
        sisa_saldo = sisa_saldo - v_total
    WHERE id = p_id_periode_keuangan;
END$$

CREATE PROCEDURE sp_keuangan_summary(IN p_bulan TINYINT, IN p_tahun SMALLINT)
BEGIN
    SELECT
        COALESCE(SUM(CASE WHEN bulan = p_bulan THEN sisa_saldo ELSE 0 END), 0) AS total_saldo_aktif,
        COALESCE(SUM(CASE WHEN bulan = p_bulan THEN dana_masuk ELSE 0 END), 0) AS pemasukan_bulan_ini,
        COALESCE(SUM(dana_masuk), 0) AS total_pemasukan_tahun,
        COALESCE(SUM(total_pengeluaran), 0) AS total_pengeluaran_tahun
    FROM Periode_Keuangan
    WHERE tahun = p_tahun;
END$$

CREATE PROCEDURE sp_keuangan_divisi_summary(IN p_bulan TINYINT, IN p_tahun SMALLINT)
BEGIN
    SELECT
        d.id,
        d.nama_divisi,
        d.kode_divisi,
        COALESCE(pk.saldo_awal, 0) AS saldo_awal,
        COALESCE(pk.total_pengeluaran, 0) AS total_pengeluaran,
        COALESCE(pk.sisa_saldo, 0) AS sisa_saldo
    FROM Divisi d
    LEFT JOIN Periode_Keuangan pk
        ON pk.id_divisi = d.id
        AND pk.bulan = p_bulan
        AND pk.tahun = p_tahun
    ORDER BY d.nama_divisi;
END$$

CREATE PROCEDURE sp_keuangan_pengeluaran_recent(IN p_bulan TINYINT, IN p_tahun SMALLINT, IN p_limit INT)
BEGIN
    SELECT
        tp.id,
        tp.tanggal_transaksi,
        tp.nama_kegiatan,
        tp.uraian_pengeluaran,
        tp.volume,
        tp.satuan,
        tp.jumlah_rupiah,
        tp.total_nominal,
        d.nama_divisi,
        pk.nama_program
    FROM Transaksi_Pengeluaran tp
    JOIN Periode_Keuangan pkh ON tp.id_periode_keuangan = pkh.id
    JOIN Divisi d ON pkh.id_divisi = d.id
    LEFT JOIN Program_Kerja pk ON tp.id_program_kerja = pk.id
    WHERE pkh.bulan = p_bulan
        AND pkh.tahun = p_tahun
    ORDER BY tp.tanggal_transaksi DESC, tp.id DESC
    LIMIT p_limit;
END$$

CREATE PROCEDURE sp_keuangan_pengeluaran_detail(IN p_id_divisi INT, IN p_bulan TINYINT, IN p_tahun SMALLINT)
BEGIN
    SELECT
        tp.id,
        tp.tanggal_transaksi,
        tp.nama_kegiatan,
        tp.uraian_pengeluaran,
        tp.volume,
        tp.satuan,
        tp.jumlah_rupiah,
        tp.total_nominal,
        tp.keterangan,
        tp.url_bukti_struk,
        pk.nama_program
    FROM Transaksi_Pengeluaran tp
    JOIN Periode_Keuangan pkh ON tp.id_periode_keuangan = pkh.id
    LEFT JOIN Program_Kerja pk ON tp.id_program_kerja = pk.id
    WHERE pkh.id_divisi = p_id_divisi
        AND pkh.bulan = p_bulan
        AND pkh.tahun = p_tahun
    ORDER BY tp.tanggal_transaksi DESC, tp.id DESC;
END$$

CREATE PROCEDURE sp_keuangan_set_saldo_awal(
    IN p_id_divisi INT,
    IN p_bulan TINYINT,
    IN p_tahun SMALLINT,
    IN p_saldo_awal DECIMAL(15,2),
    IN p_id_penanggung_jawab INT
)
BEGIN
    DECLARE v_dana_masuk DECIMAL(15,2);
    DECLARE v_total_pengeluaran DECIMAL(15,2);
    DECLARE v_exists INT DEFAULT 0;

    SELECT COUNT(*)
    INTO v_exists
    FROM Periode_Keuangan
    WHERE id_divisi = p_id_divisi
        AND bulan = p_bulan
        AND tahun = p_tahun;

    IF v_exists = 0 THEN
        INSERT INTO Periode_Keuangan
            (id_divisi, bulan, tahun, id_penanggung_jawab, saldo_awal, dana_masuk, total_dana_tersedia, total_pengeluaran, sisa_saldo, status_dokumen, dibuat_pada)
        VALUES
            (p_id_divisi, p_bulan, p_tahun, p_id_penanggung_jawab, p_saldo_awal, 0, p_saldo_awal, 0, p_saldo_awal, 'DRAFT', NOW());
    ELSE
        SELECT dana_masuk, total_pengeluaran
        INTO v_dana_masuk, v_total_pengeluaran
        FROM Periode_Keuangan
        WHERE id_divisi = p_id_divisi
            AND bulan = p_bulan
            AND tahun = p_tahun
        LIMIT 1;

        UPDATE Periode_Keuangan
        SET saldo_awal = p_saldo_awal,
            id_penanggung_jawab = p_id_penanggung_jawab,
            total_dana_tersedia = p_saldo_awal + COALESCE(v_dana_masuk, 0),
            sisa_saldo = (p_saldo_awal + COALESCE(v_dana_masuk, 0)) - COALESCE(v_total_pengeluaran, 0),
            diupdate_pada = NOW()
        WHERE id_divisi = p_id_divisi
            AND bulan = p_bulan
            AND tahun = p_tahun;
    END IF;
END$$

DELIMITER ;
